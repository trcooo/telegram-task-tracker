generator client { provider = "prisma-client-js" }

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TaskStatus { TODO DONE ARCHIVED }

enum TaskQuadrant {
  Q1_URGENT_IMPORTANT
  Q2_NOT_URGENT_IMPORTANT
  Q3_URGENT_NOT_IMPORTANT
  Q4_NOT_URGENT_NOT_IMPORTANT
}

enum ReminderStatus { PENDING SENT CANCELED }

model User {
  id        String   @id @default(cuid())
  tgId      BigInt   @unique
  username  String?
  firstName String?
  lastName  String?
  photoUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasks     Task[]
  tags      Tag[]
  projects  Project[]
  reminders Reminder[]

  @@index([tgId])
}

model Project {
  id        String   @id @default(cuid())
  userId    String
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks Task[]

  @@index([userId])
}

model Tag {
  id        String   @id @default(cuid())
  userId    String
  name      String
  color     String?
  createdAt DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskTags TaskTag[]

  @@unique([userId, name])
  @@index([userId])
}

model Task {
  id           String      @id @default(cuid())
  userId       String
  projectId    String?

  title        String
  description  String?

  status       TaskStatus  @default(TODO)
  priority     Int         @default(3)
  quadrant     TaskQuadrant?

  startAt      DateTime?
  dueAt        DateTime?
  durationMin  Int?
  rrule        String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  taskTags  TaskTag[]
  reminders Reminder[]

  @@index([userId, status])
  @@index([userId, dueAt])
  @@index([userId, startAt])
}

model TaskTag {
  taskId String
  tagId  String
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)
  @@id([taskId, tagId])
}

model Reminder {
  id        String         @id @default(cuid())
  userId    String
  taskId    String
  remindAt  DateTime
  status    ReminderStatus @default(PENDING)
  sentAt    DateTime?
  createdAt DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([status, remindAt])
  @@index([userId])
}
